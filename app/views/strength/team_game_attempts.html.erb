<% content_for :title, "#{@team.name} - Player Familiarity" %>

<%= tag.div class: "team-game-attempts-container" do %>
  <%= tag.div class: "team-game-attempts-header" do %>
    <%= tag.h1 "#{@team.name} - Player Familiarity", class: "team-game-attempts-title" %>
    <%= tag.p "View your performance with players from this team and update your familiarity ratings", class: "team-game-attempts-subtitle" %>
  <% end %>

  <% if @players.any? %>
    <%= tag.div class: "player-sections" do %>
      <% @players.each do |player| %>
        <%= tag.div class: "player-section" do %>
          <%= tag.div class: "player-section-header" do %>
            <%= tag.div class: "player-info" do %>
              <%= tag.div class: "player-photo-container" do %>
                <% if player.photo_urls.present? %>
                  <%= tag.img src: player.photo_urls.first, alt: player.full_name, class: "player-photo" %>
                <% else %>
                  <%= tag.div class: "player-photo-placeholder" do %>
                    <%= tag.i class: "fa-solid fa-user" %>
                  <% end %>
                <% end %>
              <% end %>
              
              <%= tag.div class: "player-details" do %>
                <%= tag.h2 player.full_name, class: "player-name" %>
                <% if player.primary_position %>
                  <%= tag.p player.primary_position.name, class: "player-position" %>
                <% end %>
              <% end %>
            <% end %>
            
            <%= tag.div class: "player-stats" do %>
              <%= tag.div class: "stats-group" do %>
                <%= tag.div class: "stat-item" do %>
                  <%= tag.span "All-time", class: "stat-label" %>
                  <%= tag.div class: "stat-value" do %>
                    <%= tag.span "#{@player_stats[player][:correct_attempts]}/#{@player_stats[player][:total_attempts]}", class: "stat-fraction" %>
                    <%= tag.span "(#{@player_stats[player][:accuracy]}%)", class: "stat-percentage" %>
                  <% end %>
                <% end %>
                
                <%= tag.div class: "stat-item" do %>
                  <%= tag.span "Last Week", class: "stat-label" %>
                  <%= tag.div class: "stat-value" do %>
                    <%= tag.span "#{@player_stats[player][:recent_correct]}/#{@player_stats[player][:recent_total]}", class: "stat-fraction" %>
                    <%= tag.span "(#{@player_stats[player][:recent_accuracy]}%)", class: "stat-percentage" %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
          
          <%= tag.div class: "player-ratings" do %>
            <%= tag.div class: "ratings-header" do %>
              <%= tag.h3 "Player Ratings", class: "ratings-heading" %>
              <%= tag.div class: "spectrum-selector" do %>
                <% familiarity_spectrum = Spectrum.find_by(name: 'Familiarity') %>
                <% all_spectrums = Spectrum.all.to_a %>
                <% selected_spectrums = [familiarity_spectrum] %>
                
                <%= tag.div class: "spectrum-picker" do %>
                  <%= tag.label "Select spectrum:", for: "spectrum-select-#{player.id}", class: "spectrum-label" %>
                  <%= tag.select id: "spectrum-select-#{player.id}", 
                                class: "spectrum-select",
                                data: { 
                                  action: "change->rating-slider#updateSelectedSpectrum",
                                  player_id: player.id 
                                } do %>
                    <% all_spectrums.each do |spectrum| %>
                      <%= tag.option spectrum.name, 
                                    value: spectrum.id, 
                                    selected: spectrum == familiarity_spectrum %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            
            <%= rating_slider_container(player, selected_spectrums) %>
          <% end %>
          
          <%= tag.div class: "player-attempts" do %>
            <%= tag.h3 "Recent Attempts", class: "attempts-heading" %>
            <%= tag.div class: "attempts-list" do %>
              <% @attempts_by_player[player].sort_by(&:created_at).reverse.take(5).each do |attempt| %>
                <%= tag.div class: "attempt-card #{attempt.correct? ? 'correct-attempt' : 'incorrect-attempt'}" do %>
                  <%= tag.div class: "attempt-team-part" do %>
                    <%= tag.div class: "attempt-team-logo-container" do %>
                      <%= display_name_with_lazy_logo(attempt.target_entity) %>
                    <% end %>
                    <%= tag.p attempt.target_entity.name, class: "attempt-team-name" %>
                  <% end %>
                  
                  <% unless attempt.correct? %>
                    <%= tag.div class: "chosen-team-indicator" do %>
                      Your Guess: <%= attempt.chosen_entity.name %>
                    <% end %>
                  <% end %>
                  
                  <%= tag.div class: "attempt-timestamp" do %>
                    <%= time_ago_in_words(attempt.created_at) %> ago
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% else %>
    <%= tag.div class: "empty-attempts-message" do %>
      <%= tag.p "You haven't made any game attempts with players from this team yet.", class: "empty-attempts-text" %>
      <%= link_to "Start Playing", strength_team_match_path(team_id: @team.id), class: "start-playing-button" %>
    <% end %>
  <% end %>
<% end %>
